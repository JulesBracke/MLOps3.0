name: K8s Smoke Test

on:
  workflow_dispatch:

jobs:
  k8s-smoke:
    runs-on: [self-hosted, Windows]

    defaults:
      run:
        shell: powershell

    env:
      # adjust username if needed
      KUBECONFIG: C:\Users\ieman\.kube\config
      NAMESPACE: gha-smoke

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Show kubectl + context + nodes
        run: |
          kubectl version --client=true
          kubectl config get-contexts
          kubectl config use-context k3d-mlops
          kubectl config current-context
          kubectl get nodes -o wide

      - name: Create namespace (idempotent)
        run: |
          $exists = $false
          try {
            # run and ignore stderr; do NOT let a non-zero exit stop the step
            $null = kubectl get ns $env:NAMESPACE --no-headers 2>$null
            if ($LASTEXITCODE -eq 0) { $exists = $true }
          } catch {
            $exists = $false
          }

          if (-not $exists) {
            Write-Host "Namespace '$env:NAMESPACE' not found; creatingâ€¦"
            kubectl create namespace $env:NAMESPACE
            if ($LASTEXITCODE -ne 0) { throw "Failed to create namespace $env:NAMESPACE" }
          } else {
            Write-Host "Namespace '$env:NAMESPACE' already exists."
          }

      - name: Apply test Deployment + Service (nginx)
        run: |
          $path = Join-Path $env:GITHUB_WORKSPACE "k8s\nginx-smoke.yaml"
          kubectl apply -f $path
          kubectl get all -n $env:NAMESPACE

      - name: Wait until Deployment is ready
        run: |
          kubectl rollout status deployment/nginx-smoke -n $env:NAMESPACE --timeout=90s
          kubectl get deploy,po,svc -n $env:NAMESPACE -o wide

      - name: Clean up (optional)
        if: always()
        run: |
          $path = Join-Path $env:GITHUB_WORKSPACE "k8s\nginx-smoke.yaml"
          kubectl delete -f $path --ignore-not-found=true
          # kubectl delete ns $env:NAMESPACE --ignore-not-found=true
