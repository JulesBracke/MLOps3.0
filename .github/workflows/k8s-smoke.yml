name: K8s Smoke Test

on:
  workflow_dispatch:

jobs:
  k8s-smoke:
    runs-on: [self-hosted, Windows]

    defaults:
      run:
        shell: powershell

    # adjust the username if needed
    env:
      KUBECONFIG: C:\Users\ieman\.kube\config
      NAMESPACE: gha-smoke

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Show kubectl + context + nodes
        run: |
          kubectl version --client=true
          kubectl config get-contexts
          kubectl config use-context k3d-mlops
          kubectl config current-context
          kubectl get nodes -o wide

      - name: Create namespace (idempotent)
        run: |
          if (-not (kubectl get ns $env:NAMESPACE --no-headers 2>$null)) {
            kubectl create namespace $env:NAMESPACE
          }

      - name: Apply test Deployment + Service (nginx)
        run: |
          # IMPORTANT: the here-string must start at the first column
          $manifest = @"
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-smoke
  namespace: $env:NAMESPACE
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx-smoke
  template:
    metadata:
      labels:
        app: nginx-smoke
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-smoke-svc
  namespace: $env:NAMESPACE
spec:
  selector:
    app: nginx-smoke
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http
"@
          $path = "$env:RUNNER_TEMP\nginx-smoke.yaml"
          Set-Content -Path $path -Value $manifest -Encoding UTF8
          kubectl apply -f $path

      - name: Wait until Deployment is ready
        run: |
          kubectl rollout status deployment/nginx-smoke -n $env:NAMESPACE --timeout=90s
          kubectl get deploy,po,svc -n $env:NAMESPACE -o wide

      - name: Clean up (optional)
        if: always()
        run: |
          kubectl delete -n $env:NAMESPACE -f "$env:RUNNER_TEMP\nginx-smoke.yaml" --ignore-not-found=true
          # kubectl delete ns $env:NAMESPACE --ignore-not-found=true
