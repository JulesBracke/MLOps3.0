name: K8s Pod Test

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  deploy-pod:
    runs-on: self-hosted

    defaults:
      run:
        shell: powershell

    env:
      # adjust username if needed
      KUBECONFIG: C:\Users\ieman\.kube\config
      NAMESPACE: gha-smoke

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Show kubectl + context + nodes
        run: |
          kubectl version --client=true
          kubectl config use-context k3d-mlops
          kubectl config current-context
          kubectl get nodes -o wide

      - name: Ensure namespace exists (idempotent)
        run: |
          $exists = $false
          try {
            $null = kubectl get ns $env:NAMESPACE --no-headers 2>$null
            if ($LASTEXITCODE -eq 0) { $exists = $true }
          } catch { $exists = $false }
          if (-not $exists) {
            Write-Host "Creating namespace '$env:NAMESPACE'â€¦"
            kubectl create namespace $env:NAMESPACE
            if ($LASTEXITCODE -ne 0) { throw "Failed to create namespace $env:NAMESPACE" }
          } else {
            Write-Host "Namespace '$env:NAMESPACE' already exists."
          }

      - name: Generate random pod name
        id: name
        run: |
          # random, safe, lowercase suffix
          $suffix = ([guid]::NewGuid().ToString('N')).Substring(0,8).ToLower()
          $pod = "mypod-$suffix"
          "POD_NAME=$pod" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "POD_NAME: $pod"

      - name: Create Pod manifest
        run: |
          $pod = $env:POD_NAME
          $ns  = $env:NAMESPACE
          $lines = @(
            "apiVersion: v1",
            "kind: Pod",
            "metadata:",
            "  name: $pod",
            "  namespace: $ns",
            "  labels:",
            "    name: mypod",
            "spec:",
            "  containers:",
            "  - name: mypod",
            "    image: rancher/hello-world"
          )
          $path = "$env:RUNNER_TEMP\pod-$pod.yaml"
          ($lines -join "`n") | Set-Content -Path $path -Encoding UTF8
          "POD_MANIFEST=$path" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Manifest written to: $path"

      - name: Apply Pod via kubectl
        run: |
          kubectl apply -f $env:POD_MANIFEST
          kubectl get pod $env:POD_NAME -n $env:NAMESPACE -o yaml | Select-String -Pattern '^  name:','image:'

      - name: Wait for Pod to be Ready
        run: |
          kubectl wait --for=condition=Ready pod/$env:POD_NAME -n $env:NAMESPACE --timeout=120s
          kubectl get pods -n $env:NAMESPACE -o wide

      - name: List pods in namespace
        run: |
          kubectl get pods -n $env:NAMESPACE -o wide

      - name: Cleanup (optional)
        if: always()
        run: |
          kubectl delete pod $env:POD_NAME -n $env:NAMESPACE --ignore-not-found=true
