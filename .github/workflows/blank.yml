name: Starting Pipeline

on:
  workflow_dispatch:
  pull_request:
    branches: ["main"]

jobs:
  first-pipeline:
    # Use your self-hosted runner (Windows label is optional but helpful)
    runs-on: [self-hosted, Windows]

    env:
      IMAGE_NAME: hello-world-nginx
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
      COMMIT_SHA: ${{ github.sha }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Compute image tag (branch + short sha)
        shell: pwsh
        run: |
          $sanitized = $env:BRANCH_NAME.ToLower() -replace '[^a-z0-9._-]','-'
          $shortSha = $env:COMMIT_SHA.Substring(0,7)
          $tag = "$sanitized-$shortSha"
          echo "IMAGE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Built tag: $env:IMAGE_NAME:$tag"

      - name: Build Docker image
        shell: pwsh
        run: |
          docker build `
            -t "$env:IMAGE_NAME:$env:IMAGE_TAG" `
            -t "$env:IMAGE_NAME:latest" `
            .

      - name: Run container on port 8080
        shell: pwsh
        run: |
          docker run -d --name hello-nginx -p 8080:80 "$env:IMAGE_NAME:$env:IMAGE_TAG"

      - name: Verify container responds
        shell: pwsh
        run: |
          Start-Sleep -Seconds 2
          $r = Invoke-WebRequest -Uri http://localhost:8080 -UseBasicParsing
          $r.Content | Tee-Object -FilePath output.html | Out-Null
          if ($r.Content -notmatch 'Hello world') { throw "Expected content not found" }

      - name: Show running containers
        shell: pwsh
        run: docker ps

      - name: Cleanup
        if: always()
        shell: pwsh
        run: |
          docker logs hello-nginx | Out-Host
          docker stop hello-nginx 2>$null | Out-Null
          docker rm hello-nginx 2>$null | Out-Null
