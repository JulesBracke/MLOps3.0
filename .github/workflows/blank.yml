name: Starting Pipeline

on:
  workflow_dispatch:
  pull_request:
    branches: ["main"]

jobs:
  first-pipeline:
    runs-on: [self-hosted, Windows]

    defaults:
      run:
        shell: powershell

    env:
      IMAGE_NAME: hello-world-nginx
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
      COMMIT_SHA: ${{ github.sha }}
      CONTAINER_NAME: hello-nginx

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Docker info (sanity check)
        run: |
          docker version
          docker info | Select-String -Pattern 'Operating System','OSType','Server Version'

      - name: Compute image tag (branch + short sha)
        run: |
          $sanitized = $env:BRANCH_NAME.ToLower() -replace '[^a-z0-9._-]','-'
          $shortSha  = $env:COMMIT_SHA.Substring(0,7)
          $tag       = "$sanitized-$shortSha"
          if ([string]::IsNullOrWhiteSpace($tag)) { throw "IMAGE_TAG computed empty" }
          "IMAGE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "IMAGE_TAG computed: $tag"

      - name: Build Docker image
        env:
          DOCKER_BUILDKIT: 0
        run: |
          Write-Host "Building ${env:IMAGE_NAME}:${env:IMAGE_TAG}"
          if ([string]::IsNullOrWhiteSpace(${env:IMAGE_TAG})) { throw "IMAGE_TAG missing in env" }
          docker build -t ${env:IMAGE_NAME}:${env:IMAGE_TAG} -t ${env:IMAGE_NAME}:latest .

      - name: Run container on port 8080
        run: |
          if (docker ps -a --format '{{.Names}}' | Select-String -SimpleMatch $env:CONTAINER_NAME) {
            docker rm -f $env:CONTAINER_NAME | Out-Null
          }
          docker run -d --name $env:CONTAINER_NAME -p 8080:80 ${env:IMAGE_NAME}:${env:IMAGE_TAG}

      - name: Verify container responds
        run: |
          Start-Sleep -Seconds 2
          $r = Invoke-WebRequest -Uri http://localhost:8080 -UseBasicParsing
          $r.StatusCode
          $r.Content | Tee-Object -FilePath output.html | Out-Null
          if ($r.Content -notmatch 'Hello world') { throw "Expected content not found" }

      - name: Show running containers
        run: docker ps

      - name: Cleanup (do not fail if container missing)
        if: always()
        run: |
          $exists = docker ps -a --format '{{.Names}}' | Select-String -SimpleMatch $env:CONTAINER_NAME
          if ($exists) {
            docker logs $env:CONTAINER_NAME | Out-Host
            docker stop $env:CONTAINER_NAME | Out-Null
            docker rm   $env:CONTAINER_NAME | Out-Null
          } else {
            Write-Host "Container '$env:CONTAINER_NAME' not found; skipping cleanup."
          }
